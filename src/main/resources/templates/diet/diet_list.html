<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>„ÉÄ„Ç§„Ç®„ÉÉ„Éà‰∏ÄË¶ß</title>
    <link rel="stylesheet" href="/css/commons.css">
    <link rel="stylesheet" href="/css/dietList.css">
    <link href="/css/dietdb.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>

<body>
    <th:block th:insert="/common/header.html"></th:block>

    <div class="flex-head">
        <h2>„ÉÄ„Ç§„Ç®„ÉÉ„ÉàÈÅ∏Êäû</h2>
        <img src="/images/help.png" alt="help">
    </div>

    <div class="center content">

        <div class="form">
            <div class="form-item1">
                <div class="search-favo">
                    <div class="favo-item">
                        <img id="search-favo-image" src="/images/star_on.png">
                        <input id="search-favo-checkbox" type="checkbox">
                    </div>
                    <div class="select-item">
                        <img id="search-select-image" src="/images/update.png">
                        <input id="search-select-checkbox" type="checkbox">
                    </div>
                </div>
                <div class="search-category">
                    <select name="category">
                        <option selected>„Ç´„ÉÜ„Ç¥„É™</option>
                        <option value="ÈÅãÂãï">ÈÅãÂãï</option>
                        <option value="È£ü‰∫ã">È£ü‰∫ã</option>
                    </select>
                    <select name="difficulty">
                        <option selected>Èõ£ÊòìÂ∫¶</option>
                        <option value="easy">easy</option>
                        <option value="normal">normal</option>
                        <option value="hard">hard</option>
                    </select>
                </div>

                <div class="search-keyword">
                    <div class="search-input">
                        <input type="text" placeholder="üîç ‚ÄªÈ†ÖÁõÆÂêç„Åå„Éí„ÉÉ„Éà„Åó„Åæ„Åô„ÄÇ">
                    </div>
                    <div class="search-button">
                        <button type="button" onclick="filterForm()">Áµû„ÇäËæº„ÅøÊ§úÁ¥¢</button>
                    </div>
                </div>
            </div>
        </div>


        <div class="background">
            <table>
                <thead>
                    <tr>
                        <th>„ÅäÊ∞ó„Å´ÂÖ•„Çä</th>
                        <th>ÂÆüÊñΩ</th>
                        <th>È†ÖÁõÆ</th>
                        <th>ÊúüÈñì</th>
                        <!-- <th>„Ç≥„Éü„É•„Éã„ÉÜ„Ç£</th> -->
                        <th>„Ç´„ÉÜ„Ç¥„É™</th>
                        <th>Èõ£ÊòìÂ∫¶</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                </tbody>
            </table>
        </div>



        <!---------------------------------------------------------------------------------------- „É¢„Éº„ÉÄ„É´-->
        <div id="modal">
            <div class="detail-center">
                <div class="page-button">
                    <div class="page-switch left">&blacktriangleleft;</div>
                    <div class="page-switch right">&blacktriangleright;</div>
                </div>
                <h1 id="detail-title"></h1>
                <div id="detail-text">
                </div>
                <img id="detail-img" src="">
                <button id="detail-button" type="button" onclick="closeModal()" class="cancel-btn">Èñâ„Åò„Çã</button>
            </div>
        </div>
    </div>
    <th:block th:insert="/dietdb/insert-diet-select.html"></th:block>
    <th:block th:insert="/dietdb/edit-diet-select.html"></th:block>

    <th:block th:insert="/common/footer.html"></th:block>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="/js/dietdb.js"></script>
    <script>
        var currentIndex = 0; // ÁèæÂú®Ë°®Á§∫„Åó„Å¶„ÅÑ„Çã„Éá„Éº„Çø„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
        var data = []; // „Éá„Éº„Çø„ÇíÊ†ºÁ¥ç„Åô„ÇãÈÖçÂàó

        var previousBtn = document.getElementsByClassName("page-switch")[0];
        var nextBtn = document.getElementsByClassName("page-switch")[1];

        previousBtn.addEventListener("click", function () {
            // Ââç„ÅÆ„Éö„Éº„Ç∏„Å´Âàá„ÇäÊõø„Åà„ÇãÂá¶ÁêÜ
            // „Åì„Åì„Å´ÂÆüË£Ö„ÇíËøΩÂä†
            console.log('Ââç„ÅÆ„Éö„Éº„Ç∏„Å´Âàá„ÇäÊõø„Åà');
            currentIndex--;
            createDetail(data);
        });

        nextBtn.addEventListener("click", function () {
            // Ê¨°„ÅÆ„Éö„Éº„Ç∏„Å´Âàá„ÇäÊõø„Åà„ÇãÂá¶ÁêÜ
            // „Åì„Åì„Å´ÂÆüË£Ö„ÇíËøΩÂä†
            console.log('Ê¨°„ÅÆ„Éö„Éº„Ç∏„Å´Âàá„ÇäÊõø„Åà');
            currentIndex++;
            createDetail(data);
        });


        function createDetail(data) {
            // Ë©≥Á¥∞„Éá„Éº„Çø„ÇíË°®Á§∫„Åô„ÇãË¶ÅÁ¥†„ÇíÂèñÂæó
            var titleElement = document.getElementById("detail-title");
            var textElement = document.getElementById("detail-text");
            var imgElement = document.getElementById("detail-img");
            console.log('ÁèæÂú®„ÅÆÁï™Âè∑', currentIndex);
            // „Éá„Éº„Çø„ÇíË¶ÅÁ¥†„Å´Ë®≠ÂÆö
            // „Éá„Éº„Çø„ÇíË¶ÅÁ¥†„Å´Ë®≠ÂÆö
            if (data.length > 0 && currentIndex >= 0 && currentIndex < data.length) {
                titleElement.textContent = data[currentIndex].detailTitle;
                textElement.textContent = data[currentIndex].detail;
                imgElement.src = data[currentIndex].img;
            }

            pageChenge();
        }

        function setData(receivedData) {
            data = receivedData; // Âèó„ÅëÂèñ„Å£„Åü„Éá„Éº„Çø„Çí„Çª„ÉÉ„Éà
            console.log('setData', data);
        }

        function pageChenge() {


            if (currentIndex === 0) {
                previousBtn.style.visibility = "hidden"; // ÊúÄÂàù„ÅÆË¶ÅÁ¥†„ÅÆÂ†¥Âêà„ÄÅÂâç„ÅÆ„Éú„Çø„É≥„ÇíÈùûË°®Á§∫„Å´„Åô„Çã
            } else {
                previousBtn.style.visibility = "visible"; // Ââç„ÅÆ„Éú„Çø„É≥„ÇíË°®Á§∫„Åô„Çã
            }

            if (currentIndex === data.length - 1) {
                nextBtn.style.visibility = "hidden"; // ÊúÄÂæå„ÅÆË¶ÅÁ¥†„ÅÆÂ†¥Âêà„ÄÅÊ¨°„ÅÆ„Éú„Çø„É≥„ÇíÈùûË°®Á§∫„Å´„Åô„Çã
            } else {
                nextBtn.style.visibility = "visible"; // Ê¨°„ÅÆ„Éú„Çø„É≥„ÇíË°®Á§∫„Åô„Çã
            }


        }




        //Ë©≥Á¥∞ÂèñÂæó///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        function dietDetail(dietName) {
            var modal = document.getElementById("modal");
            const url = '/api-diet-detail'; // REST„Ç≥„É≥„Éà„É≠„Éº„É©„Éº„ÅÆ„Ç®„É≥„Éâ„Éù„Ç§„É≥„ÉàURL

            const requestData = {
                dietName: dietName
            };

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
                .then(response => {
                    if (response.ok) {
                        response.json().then(data => {
                            console.log(data);
                            openModal();
                            setData(data); // „Éá„Éº„Çø„Çí„Çª„ÉÉ„Éà
                            createDetail(data);
                        })
                        console.log('Ë©≥Á¥∞ÂèñÂæóÊàêÂäü');
                    } else {
                        console.error('Ë©≥Á¥∞ÂèñÂæóÂ§±Êïó');
                    }
                })
                .catch(error => {
                    console.error('„Ç®„É©„Éº:', error);
                });
        }

        ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        getDietList();
        function getDietList() {
            fetch('/get-diet-list', {
                method: 'GET'// „É™„ÇØ„Ç®„Çπ„Éà„É°„ÇΩ„ÉÉ„Éâ„ÇíÊåáÂÆö (POST)
            })
                .then(response => response.json()) // „É¨„Çπ„Éù„É≥„Çπ„ÇíJSONÂΩ¢Âºè„ÅßÂèñÂæó
                .then(data => {
                    // „É¨„Çπ„Éù„É≥„Çπ„Éá„Éº„Çø„ÇíÂá¶ÁêÜ„Åô„Çã
                    dietTable(data);
                    console.log(data);
                })
                .catch(error => {
                    // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
                    console.error('Error:', error);
                });
        }


        filterSelectedKeywords();
        //„Ç≠„Éº„ÉØ„Éº„ÉâÁµû„ÇäËæº„Åø
        function filterSelectedKeywords() {

            var searchSelectElement = document.getElementById('search-select-image');
            var searchSelectCheckBoxElement = document.getElementById('search-select-checkbox');

            searchSelectElement.addEventListener('click', function () {
                console.log('ÈÅ∏Êäû„Åï„Çå„Åæ„Åó„Åü„ÄÇ');
                searchSelectCheckBoxElement.checked = !searchSelectCheckBoxElement.checked;
            });
        }

        // „Ç≥„Éº„Éâ„Çí„Åì„Åì„Å´Ë®òËø∞„Åô„Çã
        filterFavoKeywords();
        function filterFavoKeywords() {
            var sarchFavoElement = document.getElementById("search-favo-image");
            var searchFavoCheckBoxElement = document.getElementById('search-favo-checkbox');

            sarchFavoElement.addEventListener('click', function () {
                console.log('„ÅäÊ∞ó„Å´ÂÖ•„Çä‰∏¶„Å≥Êõø„Åà„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü„ÄÇ');
                searchFavoCheckBoxElement.checked = !searchFavoCheckBoxElement.checked;
            });
        }

        //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        function filterForm() {
            // ÈÄÅ‰ø°„Åô„Çã„Éá„Éº„Çø„ÇíÊ∫ñÂÇô„Åô„Çã
            const formData = {
                favoriteSearch: document.querySelector('#search-favo-checkbox').checked,
                selectSearch: document.querySelector('#search-select-checkbox').checked,
                categoryName: document.querySelector('select[name="category"]').value,
                difficultName: document.querySelector('select[name="difficulty"]').value,
                keywordSearch: document.querySelector('input[type="text"]').value
            };

            // fetch„Çí‰Ωø„Å£„Å¶„Éá„Éº„Çø„ÇíÈÄÅ‰ø°„Åô„Çã
            fetch('/api-filter', {
                method: 'POST', // „É™„ÇØ„Ç®„Çπ„Éà„É°„ÇΩ„ÉÉ„Éâ„ÇíÊåáÂÆö (POST)
                headers: {
                    'Content-Type': 'application/json' // „É™„ÇØ„Ç®„Çπ„Éà„Éò„ÉÉ„ÉÄ„Éº„ÅÆContent-Type„ÇíJSONÂΩ¢Âºè„Å´ÊåáÂÆö
                },
                body: JSON.stringify(formData) // ÈÄÅ‰ø°„Åô„Çã„Éá„Éº„Çø„ÇíJSONÂΩ¢Âºè„Å´Â§âÊèõ
            })
                .then(response => response.json()) // „É¨„Çπ„Éù„É≥„Çπ„ÇíJSONÂΩ¢Âºè„ÅßÂèñÂæó
                .then(data => {
                    // „É¨„Çπ„Éù„É≥„Çπ„Éá„Éº„Çø„ÇíÂá¶ÁêÜ„Åô„Çã
                    console.log(data);
                    dietTable(data);
                })
                .catch(error => {
                    // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
                    console.error('Error:', error);
                });
        }



        //////////////////////////////////////////////////////////////////////////////////////////////////
        function dietTable(data) {
            var tableBodyElement = document.getElementById('table-body');
            console.log(tableBodyElement);

            tableBodyElement.innerHTML = '';

            for (let i = 0; i < data.length; i++) {
                var tr = document.createElement("tr");
                tableBodyElement.appendChild(tr);

                var favo = document.createElement("td");
                var favoImage = document.createElement("img");
                data[i].favorite;
                favo.classList.add("star-img");
                favo.classList.add("td-favo");
                console.log(data[i].favorite);

                if (data[i].favorite) {
                    favoImage.setAttribute("src", "/images/star_on.png");
                } else {
                    favoImage.setAttribute("src", "/images/star_off.png");
                }

                favo.appendChild(favoImage);

                var select = document.createElement("td");
                select.setAttribute("class","td-select");
                var selectImage = document.createElement("img");
                var selectinput = document.createElement("input");
                selectinput.type = "hidden";
                selectinput.value = data[i].select;

                if (data[i].select !== null) {
                    selectImage.setAttribute("src", "/images/update.png");
                    selectImage.setAttribute('onclick', 'editOpenModal(this)');       //Á∑®ÈõÜModal
                } else {
                    selectImage.setAttribute("src", "/images/add.png");
                    selectImage.setAttribute('onclick', 'insertOpenModal(this)');       //ÁôªÈå≤Modal
                }
                selectImage.setAttribute("class", "pointer");
                select.appendChild(selectImage);
                select.appendChild(selectinput);

                var dietName = document.createElement("td");
                dietName.setAttribute("class", "diet-list");
                dietName.classList.add("td-dietName");
                dietName.classList.add("background-"+(data[i].id));
                dietName.textContent = data[i].dietName;

                var period = document.createElement("td");
                period.textContent = data[i].period;
                period.setAttribute("class","td-period");

                var categoryName = document.createElement("td");
                categoryName.textContent = data[i].categoryName;
                categoryName.setAttribute("class","td-categoryName");

                var difficultName = document.createElement("td");
                difficultName.textContent = data[i].difficultName;
                difficultName.setAttribute("class","td-difficultName");


                tr.appendChild(favo);
                tr.appendChild(select);
                tr.appendChild(dietName);
                tr.appendChild(period);
                tr.appendChild(categoryName);
                tr.appendChild(difficultName);
            }

            getStarImages(); //Êòü„ÅÆÁîªÂÉèÂèñÂæó

            var dietLists = document.getElementsByClassName('diet-list');
            console.log('dietList', dietLists);

            Array.from(dietLists).forEach(function (dietList) {

                dietList.addEventListener('click', function () {
                    var dietName = dietList.textContent;
                    dietDetail(dietName);
                });
            });
        }


        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        function openModal() {
            let gray_out = document.getElementById("fadeLayer");
            gray_out.style.visibility = "visible";
            setTimeout(addClass, 200);
        }

        function closeModal() {
            let modal = document.getElementById('modal');
            let gray_out = document.getElementById("fadeLayer");
            modal.classList.remove('is-show');
            gray_out.style.visibility = "hidden";
            currentIndex = 0; // ÁèæÂú®Ë°®Á§∫„Åó„Å¶„ÅÑ„Çã„Éá„Éº„Çø„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ
        }

        function addClass() {
            let modal = document.getElementById('modal');
            modal.classList.add('is-show');
        }


        //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        var imagePaths = ["/images/star_off.png", "/images/star_on.png"]; // Âàá„ÇäÊõø„Åà„ÇãÁîªÂÉè„ÅÆ„Éë„Çπ„ÇíÈÖçÂàó„ÅßÁî®ÊÑè
        function getStarImages() {
            var starImages = document.getElementsByClassName('star-img');
            console.log('starImages', starImages);
            Array.from(starImages).forEach(function (starImage) { //„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Çâ
                //Ë°®Á§∫„Åï„Çå„Å¶„ÅÑ„ÇãÁîªÂÉè„Å´„Çà„Å£„Å¶ÂàùÊúüÂåñ„ÇíÂ§â„Åà„Çã
                var currentImagePath = starImage.children[0].src;//ÁîªÂÉèË¶ÅÁ¥†„ÇíÂèñÂæó
                var relativeImagePath = currentImagePath.replace("http://localhost:8080", "");
                var currentIndex = imagePaths.indexOf(relativeImagePath);

                starImage.addEventListener('click', function () {
                    console.log('„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü', starImage);
                    var row = starImage.closest('tr');

                    // Ë°åÂÜÖ„ÅÆÂêÑ„Çª„É´ÔºàtdË¶ÅÁ¥†Ôºâ„Åã„Çâ„ÉÄ„Ç§„Ç®„ÉÉ„ÉàÊÉÖÂ†±„ÇíÂèñÂæó
                    var dietName = row.querySelector('td:nth-child(3)').textContent;

                    currentIndex === 0 ? addToFavorites(dietName) : removeFromFavorites(dietName);//ÂÆüË°å„ÇíÂàá„ÇäÊõø„Åà„Çã

                    currentIndex = (currentIndex + 1) % imagePaths.length; // Ê¨°„ÅÆÁîªÂÉè„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíË®àÁÆó
                    starImage.getElementsByTagName('img')[0].src = imagePaths[currentIndex]; // ÁîªÂÉè„ÇíÂàá„ÇäÊõø„Åà„Çã

                });
            });
        }





        ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        function addToFavorites(dietName) {
            const url = '/api-diet-favorite'; // REST„Ç≥„É≥„Éà„É≠„Éº„É©„Éº„ÅÆ„Ç®„É≥„Éâ„Éù„Ç§„É≥„ÉàURL

            const requestData = {
                dietName: dietName
            };

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
                .then(response => {
                    if (response.ok) {
                        console.log('„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅåËøΩÂä†„Åï„Çå„Åæ„Åó„Åü');
                    } else {
                        console.error('„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                })
                .catch(error => {
                    console.error('„Ç®„É©„Éº:', error);
                });
        }


        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        function removeFromFavorites(dietName) {
            const url = '/api-diet-favorite'; // REST„Ç≥„É≥„Éà„É≠„Éº„É©„Éº„ÅÆ„Ç®„É≥„Éâ„Éù„Ç§„É≥„ÉàURL

            const requestData = {
                dietName: dietName
            };

            fetch(url, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
                .then(response => {
                    if (response.ok) {
                        console.log('„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„Åü');
                    } else {
                        console.error('„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                })
                .catch(error => {
                    console.error('„Ç®„É©„Éº:', error);
                });
        }
    </script>
</body>

</html>