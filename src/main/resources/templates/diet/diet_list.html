<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>ãƒ€ã‚¤ã‚¨ãƒƒãƒˆä¸€è¦§</title>
    <link rel="stylesheet" href="/css/commons.css">
    <link rel="stylesheet" href="/css/dietList.css">
    <link href="/css/dietdb.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>

<body>
    <th:block th:insert="/common/header.html"></th:block>

    <div class="flex-head">
        <h2>ãƒ€ã‚¤ã‚¨ãƒƒãƒˆé¸æŠ</h2>
        <img src="/images/help.png" alt="help">
    </div>

    <div class="center content">

        <div class="form">
            <div class="form-item1">
                <div class="search-favo">
                    <div class="favo-item">
                        <img id="search-favo-image" src="/images/star_on.png">
                        <input id="search-favo-checkbox" type="checkbox">
                    </div>
                    <div class="select-item">
                        <img id="search-select-image" src="/images/update.png">
                        <input id="search-select-checkbox" type="checkbox">
                    </div>
                </div>
                <div class="search-category">
                    <select name="category">
                        <option selected>ã‚«ãƒ†ã‚´ãƒª</option>
                        <option value="é‹å‹•">é‹å‹•</option>
                        <option value="é£Ÿäº‹">é£Ÿäº‹</option>
                    </select>
                    <select name="difficulty" id="difficulty-select">
                        <option selected>é›£æ˜“åº¦</option>
                        <option value="easy" class="select-easy">â˜…</option>
                        <option value="normal" class="select-normal">â˜…â˜…</option>
                        <option value="hard" class="select-hard">â˜…â˜…â˜…</option>
                    </select>
                </div>

                <div class="search-keyword">
                    <div class="search-input">
                        <input type="text" placeholder="ğŸ” â€»é …ç›®åãŒãƒ’ãƒƒãƒˆã—ã¾ã™ã€‚">
                    </div>
                    <div class="search-button">
                        <button type="button" onclick="filterForm()">çµã‚Šè¾¼ã¿æ¤œç´¢</button>
                    </div>
                </div>
            </div>
        </div>


        <div class="background">
            <table>
                <thead>
                    <tr>
                        <th>ãŠæ°—ã«å…¥ã‚Š</th>
                        <th>å®Ÿæ–½</th>
                        <th>é …ç›®</th>
                        <th>æœŸé–“</th>
                        <!-- <th>ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£</th> -->
                        <th>ã‚«ãƒ†ã‚´ãƒª</th>
                        <th>é›£æ˜“åº¦</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                </tbody>
            </table>
        </div>



        <!---------------------------------------------------------------------------------------- ãƒ¢ãƒ¼ãƒ€ãƒ«-->
        <div id="modal">
            <div class="detail-center">
                <div class="page-button">
                    <div class="page-switch left">&blacktriangleleft;</div>
                    <div class="page-switch right">&blacktriangleright;</div>
                </div>
                <h1 id="detail-title"></h1>
                <div id="detail-text">
                </div>
                <img id="detail-img" src="">
                <button id="detail-button" type="button" onclick="closeModal()" class="cancel-btn">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
    <th:block th:insert="/dietdb/insert-diet-select.html"></th:block>
    <th:block th:insert="/dietdb/edit-diet-select.html"></th:block>

    <th:block th:insert="/common/footer.html"></th:block>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="/js/dietdb.js"></script>
    <script>
        var currentIndex = 0; // ç¾åœ¨è¡¨ç¤ºã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        var data = []; // ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹é…åˆ—

        var previousBtn = document.getElementsByClassName("page-switch")[0];
        var nextBtn = document.getElementsByClassName("page-switch")[1];

        previousBtn.addEventListener("click", function () {
            // å‰ã®ãƒšãƒ¼ã‚¸ã«åˆ‡ã‚Šæ›¿ãˆã‚‹å‡¦ç†
            // ã“ã“ã«å®Ÿè£…ã‚’è¿½åŠ 
            console.log('å‰ã®ãƒšãƒ¼ã‚¸ã«åˆ‡ã‚Šæ›¿ãˆ');
            currentIndex--;
            createDetail(data);
        });

        nextBtn.addEventListener("click", function () {
            // æ¬¡ã®ãƒšãƒ¼ã‚¸ã«åˆ‡ã‚Šæ›¿ãˆã‚‹å‡¦ç†
            // ã“ã“ã«å®Ÿè£…ã‚’è¿½åŠ 
            console.log('æ¬¡ã®ãƒšãƒ¼ã‚¸ã«åˆ‡ã‚Šæ›¿ãˆ');
            currentIndex++;
            createDetail(data);
        });


        function createDetail(data) {
            // è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹è¦ç´ ã‚’å–å¾—
            var titleElement = document.getElementById("detail-title");
            var textElement = document.getElementById("detail-text");
            var imgElement = document.getElementById("detail-img");
            console.log('ç¾åœ¨ã®ç•ªå·', currentIndex);
            // ãƒ‡ãƒ¼ã‚¿ã‚’è¦ç´ ã«è¨­å®š
            // ãƒ‡ãƒ¼ã‚¿ã‚’è¦ç´ ã«è¨­å®š
            if (data.length > 0 && currentIndex >= 0 && currentIndex < data.length) {
                titleElement.textContent = data[currentIndex].detailTitle;
                textElement.textContent = data[currentIndex].detail;
                imgElement.src = data[currentIndex].img;
            }

            pageChenge();
        }

        function setData(receivedData) {
            data = receivedData; // å—ã‘å–ã£ãŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
            console.log('setData', data);
        }

        function pageChenge() {


            if (currentIndex === 0) {
                previousBtn.style.visibility = "hidden"; // æœ€åˆã®è¦ç´ ã®å ´åˆã€å‰ã®ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            } else {
                previousBtn.style.visibility = "visible"; // å‰ã®ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹
            }

            if (currentIndex === data.length - 1) {
                nextBtn.style.visibility = "hidden"; // æœ€å¾Œã®è¦ç´ ã®å ´åˆã€æ¬¡ã®ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            } else {
                nextBtn.style.visibility = "visible"; // æ¬¡ã®ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹
            }


        }




        //è©³ç´°å–å¾—///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        function dietDetail(dietName) {
            var modal = document.getElementById("modal");
            const url = '/api-diet-detail'; // RESTã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURL

            const requestData = {
                dietName: dietName
            };

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
                .then(response => {
                    if (response.ok) {
                        response.json().then(data => {
                            console.log(data);
                            openModal();
                            setData(data); // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
                            createDetail(data);
                        })
                        console.log('è©³ç´°å–å¾—æˆåŠŸ');
                    } else {
                        console.error('è©³ç´°å–å¾—å¤±æ•—');
                    }
                })
                .catch(error => {
                    console.error('ã‚¨ãƒ©ãƒ¼:', error);
                });
        }

        ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        getDietList();
        function getDietList() {
            fetch('/get-diet-list', {
                method: 'GET'// ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒ‡å®š (POST)
            })
                .then(response => response.json()) // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’JSONå½¢å¼ã§å–å¾—
                .then(data => {
                    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã™ã‚‹
                    dietTable(data);
                    console.log(data);
                })
                .catch(error => {
                    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                    console.error('Error:', error);
                });
        }


        filterSelectedKeywords();
        //ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰çµã‚Šè¾¼ã¿
        function filterSelectedKeywords() {

            var searchSelectElement = document.getElementById('search-select-image');
            var searchSelectCheckBoxElement = document.getElementById('search-select-checkbox');

            searchSelectElement.addEventListener('click', function () {
                console.log('é¸æŠã•ã‚Œã¾ã—ãŸã€‚');
                searchSelectCheckBoxElement.checked = !searchSelectCheckBoxElement.checked;
            });
        }

        // ã‚³ãƒ¼ãƒ‰ã‚’ã“ã“ã«è¨˜è¿°ã™ã‚‹
        filterFavoKeywords();
        function filterFavoKeywords() {
            var sarchFavoElement = document.getElementById("search-favo-image");
            var searchFavoCheckBoxElement = document.getElementById('search-favo-checkbox');

            sarchFavoElement.addEventListener('click', function () {
                console.log('ãŠæ°—ã«å…¥ã‚Šä¸¦ã³æ›¿ãˆãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚');
                searchFavoCheckBoxElement.checked = !searchFavoCheckBoxElement.checked;
            });
        }

        //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        function filterForm() {
            // é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ã™ã‚‹
            const formData = {
                favoriteSearch: document.querySelector('#search-favo-checkbox').checked,
                selectSearch: document.querySelector('#search-select-checkbox').checked,
                categoryName: document.querySelector('select[name="category"]').value,
                difficultName: document.querySelector('select[name="difficulty"]').value,
                keywordSearch: document.querySelector('input[type="text"]').value
            };

            // fetchã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹
            fetch('/api-filter', {
                method: 'POST', // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒ‡å®š (POST)
                headers: {
                    'Content-Type': 'application/json' // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã®Content-Typeã‚’JSONå½¢å¼ã«æŒ‡å®š
                },
                body: JSON.stringify(formData) // é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã«å¤‰æ›
            })
                .then(response => response.json()) // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’JSONå½¢å¼ã§å–å¾—
                .then(data => {
                    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã™ã‚‹
                    console.log(data);
                    dietTable(data);
                })
                .catch(error => {
                    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                    console.error('Error:', error);
                });
        }



        //////////////////////////////////////////////////////////////////////////////////////////////////
        function dietTable(data) {
            var tableBodyElement = document.getElementById('table-body');
            console.log(tableBodyElement);

            tableBodyElement.innerHTML = '';

            for (let i = 0; i < data.length; i++) {
                var tr = document.createElement("tr");
                tableBodyElement.appendChild(tr);

                var favo = document.createElement("td");
                var favoImage = document.createElement("img");
                data[i].favorite;
                favo.classList.add("star-img");
                favo.classList.add("td-favo");
                console.log(data[i].favorite);

                if (data[i].favorite) {
                    favoImage.setAttribute("src", "/images/star_on.png");
                } else {
                    favoImage.setAttribute("src", "/images/star_off.png");
                }

                favo.appendChild(favoImage);

                var select = document.createElement("td");
                select.setAttribute("class", "td-select");
                var selectImage = document.createElement("img");
                var selectinput = document.createElement("input");
                selectinput.type = "hidden";
                selectinput.value = data[i].select;

                if (data[i].select !== null) {
                    selectImage.setAttribute("src", "/images/update.png");
                    selectImage.setAttribute('onclick', 'editOpenModal(this)');       //ç·¨é›†Modal
                } else {
                    selectImage.setAttribute("src", "/images/add.png");
                    selectImage.setAttribute('onclick', 'insertOpenModal(this)');       //ç™»éŒ²Modal
                }
                selectImage.setAttribute("class", "pointer");
                select.appendChild(selectImage);
                select.appendChild(selectinput);

                var dietName = document.createElement("td");
                dietName.setAttribute("class", "diet-list");
                dietName.classList.add("td-dietName");
                dietName.classList.add("background-" + (data[i].id));
                dietName.textContent = data[i].dietName;

                var period = document.createElement("td");
                period.textContent = data[i].period;
                period.setAttribute("class", "td-period");

                var categoryName = document.createElement("td");
                var categoryImage = document.createElement("img");
                // categoryName.textContent = data[i].categoryName;
                switch (data[i].categoryName) {
                    case 'é‹å‹•': categoryImage.setAttribute("src", "/images/category/motion.png");
                        break;
                    case 'é£Ÿäº‹': categoryImage.setAttribute("src", "/images/category/meal.png");
                        break;
                }

                categoryName.setAttribute("class", "td-categoryName");
                categoryName.appendChild(categoryImage);

                var difficultName = document.createElement("td");
                var difficultImage = document.createElement("img");
                // difficultName.textContent = data[i].difficultName;
                switch (data[i].difficultName) {
                    case 'easy': difficultImage.setAttribute("src", "/images/difficulty_/easy.png");
                        break;
                    case 'normal': difficultImage.setAttribute("src", "/images/difficulty_/normal.png");
                        break;
                    case 'hard': difficultImage.setAttribute("src", "/images/difficulty_/hard.png");
                        break;
                }
                difficultName.setAttribute("class", "td-difficultName");
                difficultName.appendChild(difficultImage);

                tr.appendChild(favo);
                tr.appendChild(select);
                tr.appendChild(dietName);
                tr.appendChild(period);
                tr.appendChild(categoryName);
                tr.appendChild(difficultName);
            }

            getStarImages(); //æ˜Ÿã®ç”»åƒå–å¾—

            var dietLists = document.getElementsByClassName('diet-list');
            console.log('dietList', dietLists);

            Array.from(dietLists).forEach(function (dietList) {

                dietList.addEventListener('click', function () {
                    var dietName = dietList.textContent;
                    dietDetail(dietName);
                });
            });
        }


        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        function openModal() {
            let gray_out = document.getElementById("fadeLayer");
            gray_out.style.visibility = "visible";
            setTimeout(addClass, 200);
        }

        function closeModal() {
            let modal = document.getElementById('modal');
            let gray_out = document.getElementById("fadeLayer");
            modal.classList.remove('is-show');
            gray_out.style.visibility = "hidden";
            currentIndex = 0; // ç¾åœ¨è¡¨ç¤ºã—ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
        }

        function addClass() {
            let modal = document.getElementById('modal');
            modal.classList.add('is-show');
        }


        //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        var imagePaths = ["/images/star_off.png", "/images/star_on.png"]; // åˆ‡ã‚Šæ›¿ãˆã‚‹ç”»åƒã®ãƒ‘ã‚¹ã‚’é…åˆ—ã§ç”¨æ„
        function getStarImages() {
            var starImages = document.getElementsByClassName('star-img');
            console.log('starImages', starImages);
            Array.from(starImages).forEach(function (starImage) { //ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚‰
                //è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ç”»åƒã«ã‚ˆã£ã¦åˆæœŸåŒ–ã‚’å¤‰ãˆã‚‹
                var currentImagePath = starImage.children[0].src;//ç”»åƒè¦ç´ ã‚’å–å¾—
                var relativeImagePath = currentImagePath.replace("http://localhost:8080", "");
                var currentIndex = imagePaths.indexOf(relativeImagePath);

                starImage.addEventListener('click', function () {
                    console.log('ã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ', starImage);
                    var row = starImage.closest('tr');

                    // è¡Œå†…ã®å„ã‚»ãƒ«ï¼ˆtdè¦ç´ ï¼‰ã‹ã‚‰ãƒ€ã‚¤ã‚¨ãƒƒãƒˆæƒ…å ±ã‚’å–å¾—
                    var dietName = row.querySelector('td:nth-child(3)').textContent;

                    currentIndex === 0 ? addToFavorites(dietName) : removeFromFavorites(dietName);//å®Ÿè¡Œã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹

                    currentIndex = (currentIndex + 1) % imagePaths.length; // æ¬¡ã®ç”»åƒã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—
                    starImage.getElementsByTagName('img')[0].src = imagePaths[currentIndex]; // ç”»åƒã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹

                });
            });
        }





        ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        function addToFavorites(dietName) {
            const url = '/api-diet-favorite'; // RESTã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURL

            const requestData = {
                dietName: dietName
            };

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
                .then(response => {
                    if (response.ok) {
                        console.log('ãŠæ°—ã«å…¥ã‚ŠãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ');
                    } else {
                        console.error('ãŠæ°—ã«å…¥ã‚Šã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                })
                .catch(error => {
                    console.error('ã‚¨ãƒ©ãƒ¼:', error);
                });
        }


        /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
        function removeFromFavorites(dietName) {
            const url = '/api-diet-favorite'; // RESTã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆURL

            const requestData = {
                dietName: dietName
            };

            fetch(url, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
                .then(response => {
                    if (response.ok) {
                        console.log('ãŠæ°—ã«å…¥ã‚ŠãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ');
                    } else {
                        console.error('ãŠæ°—ã«å…¥ã‚Šã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                })
                .catch(error => {
                    console.error('ã‚¨ãƒ©ãƒ¼:', error);
                });
        }
        const selectElement = document.getElementById('difficulty-select');

        selectElement.addEventListener('change', function () {
            const selectedOption = this.options[this.selectedIndex];
            const className = selectedOption.getAttribute('class');

            // ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            selectElement.classList.remove('select-easy');
            selectElement.classList.remove('select-normal');
            selectElement.classList.remove('select-hard');

            // é¸æŠã•ã‚ŒãŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«å¯¾å¿œã™ã‚‹ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            selectElement.classList.add(className);
        });
    </script>
</body>

</html>